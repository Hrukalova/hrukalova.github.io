<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создать задачи</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <script>
        if (!localStorage.getItem('currentUser')) {
            window.location.href = 'index.html';
        }
    </script>

    <header class="header">
        <a href="create-sections.html" class="icon-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">
            <h1>Создать задачи</h1>
        </div>
        <div class="header-actions">
            <span class="task-counter" id="taskCounter">задача 1</span>
        </div>
    </header>

    <main class="container create-tasks">
        <form id="taskForm">
            <div class="form-section">
                <h2>название задачи</h2>
                <input type="text"
                       id="taskName"
                       class="form-input"
                       placeholder="Например: Сделать макет главной страницы">
            </div>

            <div class="form-section">
                <h2>дедлайн</h2>
                <div class="deadline-input">
                    <input type="date" id="taskDate" class="form-input">
                    <input type="time" id="taskTime" class="form-input" value="12:00">
                </div>
                <p class="form-hint" id="deadlineHint">Выберите дату</p>
            </div>

            <div class="form-section">
                <h2>раздел проекта</h2>
                <select id="taskSection" class="form-input">
                    </select>
            </div>

            <div class="form-section">
                <h2>ответственные</h2>
                <div class="members-selection" id="responsibleMembers">
                    </div>
            </div>

            <div class="form-section">
                <h2>описание</h2>
                <textarea id="taskDescription" class="form-input textarea"
                          rows="4"
                          placeholder="Детали задачи..."></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="addAnotherTask()">
                    <i class="fas fa-plus"></i> Добавить еще задачу
                </button>
                <button type="button" class="btn btn-primary" onclick="saveTasksAndFinish()">
                    ГОТОВО
                </button>
            </div>
        </form>
    </main>

    <script>
        let currentTaskNumber = 1;
        let allTasks = JSON.parse(sessionStorage.getItem('tempTasks') || '[]');

        // Загружаем данные проекта из сессии
        let tempProject = JSON.parse(sessionStorage.getItem('tempProject') || '{}');
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        document.addEventListener('DOMContentLoaded', function() {
            // Если разделов нет, возвращаем на шаг назад
            if (!tempProject.sections || tempProject.sections.length === 0) {
                alert("Сначала создайте разделы!");
                window.location.href = 'create-sections.html';
                return;
            }

            // 1. Загружаем участников (с красивыми именами)
            loadMembers();

            // 2. Загружаем разделы в выпадающий список
            loadSections();

            // 3. Настройка даты
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('taskDate').value = today;
            updateDeadlineHint();

            document.getElementById('taskDate').addEventListener('change', updateDeadlineHint);

            // Если вернулись назад и задачи уже были, обновляем счетчик
            if (allTasks.length > 0) {
                currentTaskNumber = allTasks.length + 1;
                updateCounter();
            }
        });

        function loadMembers() {
            const membersContainer = document.getElementById('responsibleMembers');
            membersContainer.innerHTML = '';

            // Берем список участников (или только себя, если пусто)
            const membersList = tempProject.members && tempProject.members.length > 0
                                ? tempProject.members
                                : [currentUser.email];

            membersList.forEach((member, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-checkbox';
                // Первого участника выбираем по умолчанию для удобства
                if (index === 0) memberDiv.classList.add('active');

                // --- ЛОГИКА КРАСИВОГО ИМЕНИ ---
                let displayName = member;
                let initials = 'U';

                // Если это email (содержит @)
                if (member.includes('@')) {
                    const login = member.split('@')[0]; // Берем всё до собаки
                    // Делаем первую букву заглавной (ula -> Ula)
                    displayName = login.charAt(0).toUpperCase() + login.slice(1);
                    initials = displayName.charAt(0);
                } else {
                    // Если это уже имя (например, "Иван Петров")
                    displayName = member;
                    initials = member.charAt(0).toUpperCase();
                }
                // -----------------------------

                memberDiv.innerHTML = `
                    <span class="member-avatar">${initials}</span>
                    <span class="member-name">${displayName}</span>
                    <i class="fas fa-check"></i>
                    <input type="hidden" value="${member}">
                `;

                memberDiv.onclick = function() {
                    this.classList.toggle('active');
                };

                membersContainer.appendChild(memberDiv);
            });
        }

        function loadSections() {
            const sectionSelect = document.getElementById('taskSection');
            sectionSelect.innerHTML = '';

            tempProject.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }

        function updateDeadlineHint() {
            const dateVal = document.getElementById('taskDate').value;
            if (dateVal) {
                const date = new Date(dateVal);
                document.getElementById('deadlineHint').textContent = date.toLocaleDateString('ru-RU', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
            }
        }

        function updateCounter() {
            document.getElementById('taskCounter').textContent = `задача ${currentTaskNumber}`;
        }

        function saveCurrentTask() {
            // Собираем email выбранных участников из скрытых полей
            const selectedMembers = [];
            document.querySelectorAll('.member-checkbox.active input').forEach(input => {
                selectedMembers.push(input.value);
            });

            // Если никто не выбран, назначаем создателя
            if (selectedMembers.length === 0) {
                selectedMembers.push(currentUser.email);
            }

            const task = {
                id: Date.now(),
                title: document.getElementById('taskName').value || `Задача ${currentTaskNumber}`,
                description: document.getElementById('taskDescription').value,
                deadline: document.getElementById('taskDate').value + 'T' + document.getElementById('taskTime').value,
                assignees: selectedMembers, // Сохраняем email
                section: document.getElementById('taskSection').value,
                priority: 'medium',
                completed: false
            };

            allTasks.push(task);
            sessionStorage.setItem('tempTasks', JSON.stringify(allTasks));
        }

        function addAnotherTask() {
            saveCurrentTask();
            currentTaskNumber++;
            updateCounter();

            // Очищаем поля
            document.getElementById('taskName').value = '';
            document.getElementById('taskDescription').value = '';
            window.scrollTo(0,0);
        }

        function saveTasksAndFinish() {
            saveCurrentTask();

            // Финальная сборка проекта
            tempProject.id = Date.now();
            tempProject.createdAt = new Date().toISOString();
            tempProject.tasks = allTasks;
            tempProject.progress = 0;
            if (!tempProject.name) tempProject.name = "Новый проект";

            // Сохраняем в базу (localStorage)
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            projects.push(tempProject);
            localStorage.setItem('projects', JSON.stringify(projects));

            // Чистим временную память
            sessionStorage.removeItem('tempProject');
            sessionStorage.removeItem('tempTasks');

            // На главную
            window.location.href = 'dashboard.html';
        }
        // Добавляем функцию отметки задачи выполненной прямо при создании
        function markTaskAsCompleted(taskId) {
            const tasks = JSON.parse(sessionStorage.getItem('tempTasks') || '[]');
            const taskIndex = tasks.findIndex(t => t.id === taskId);

            if (taskIndex !== -1) {
                tasks[taskIndex].completed = true;
                sessionStorage.setItem('tempTasks', JSON.stringify(tasks));

                // Обновляем отображение если нужно
                if (typeof loadUserTasks === 'function') {
                    loadUserTasks();
                }

                alert('Задача отмечена как выполненная!');
            }
        }
    </script>
</body>
</html>
