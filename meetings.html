<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–≤–æ–Ω—ã</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <script>
        if (!localStorage.getItem('currentUser')) {
            window.location.href = 'index.html';
        }

        const settings = JSON.parse(localStorage.getItem('settings') || '{}');
        if (settings.darkTheme) {
            document.body.classList.add('dark-theme');
        }
    </script>

    <header class="header">
        <a href="dashboard.html" class="icon-btn">
            <i class="fas fa-arrow-left"></i>
        </a>

        <div class="header-title">
            <h1>–°–æ–∑–≤–æ–Ω—ã</h1>
        </div>

        <div class="header-actions">
            <button class="icon-btn" onclick="showMeetingHistory()" title="–ò—Å—Ç–æ—Ä–∏—è –≤—Å—Ç—Ä–µ—á">
                <i class="fas fa-history"></i>
            </button>
        </div>
    </header>

    <main class="container meetings-page">
        <!-- –í—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ -->
        <div class="project-selection">
            <h3><i class="fas fa-project-diagram"></i> –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</h3>
            <select id="projectSelect" class="form-input" onchange="loadProjectMembers()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–æ–∑–≤–æ–Ω–∞</option>
                <!-- –ü—Ä–æ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </select>
            <div class="selected-project-info" id="projectInfo" style="display: none;">
                <p id="projectMembersCount"></p>
            </div>
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h3><i class="far fa-calendar-alt"></i> –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
                <div class="month-navigation">
                    <button class="icon-btn" onclick="previousMonth()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="current-month" id="currentMonth"></span>
                    <button class="icon-btn" onclick="nextMonth()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
                <div class="calendar-day-header">–ü–Ω</div>
                <div class="calendar-day-header">–í—Ç</div>
                <div class="calendar-day-header">–°—Ä</div>
                <div class="calendar-day-header">–ß—Ç</div>
                <div class="calendar-day-header">–ü—Ç</div>
                <div class="calendar-day-header">–°–±</div>
                <div class="calendar-day-header">–í—Å</div>

                <!-- –î–Ω–∏ –º–µ—Å—è—Ü–∞ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>

        <!-- –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="time-selection">
            <div class="time-selection-header">
                <h3><i class="far fa-clock"></i> –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h3>
                <div class="time-range">
                    <span>—Å</span>
                    <input type="time" id="timeFrom" class="time-input" value="09:00">
                    <span>–¥–æ</span>
                    <input type="time" id="timeTo" class="time-input" value="18:00">
                    <button class="btn btn-small" onclick="loadTimeSlots()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>

            <div class="time-slots-grid" id="timeSlotsGrid">
                <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <div class="selected-time-info" id="selectedTimeInfo" style="display: none;">
                <p><i class="fas fa-check-circle"></i> –í—ã–±—Ä–∞–Ω–æ: <span id="selectedDateTime"></span></p>
            </div>
        </div>

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
        <div class="participants-section">
            <h3><i class="fas fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <div class="participants-list" id="participantsList">
                <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
            <div class="participants-actions">
                <button class="btn btn-outline" onclick="selectAllParticipants()">
                    <i class="fas fa-check-double"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö
                </button>
                <button class="btn btn-outline" onclick="deselectAllParticipants()">
                    <i class="fas fa-times"></i> –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                </button>
            </div>
        </div>
    </main>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ -->
    <div class="meeting-actions-bottom">
        <button class="btn btn-primary btn-block" onclick="createMeeting()" id="createMeetingBtn" disabled>
            <i class="fas fa-calendar-plus"></i> –°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É
        </button>
    </div>

    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let selectedProject = null;
        let selectedParticipants = new Set();
        let userProjects = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadUserProjects();
            renderCalendar();
            loadTimeSlots();
        });

        function loadUserProjects() {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            userProjects = projects.filter(project =>
                project.members && project.members.includes(currentUser.email)
            );

            const projectSelect = document.getElementById('projectSelect');
            projectSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–æ–∑–≤–æ–Ω–∞</option>';

            userProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)`;
                projectSelect.appendChild(option);
            });
        }

        function loadProjectMembers() {
            const projectId = document.getElementById('projectSelect').value;
            selectedProject = userProjects.find(p => p.id == projectId);

            const projectInfo = document.getElementById('projectInfo');
            const participantsList = document.getElementById('participantsList');

            if (!selectedProject) {
                projectInfo.style.display = 'none';
                participantsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</p>';
                selectedParticipants.clear();
                updateCreateButton();
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
            document.getElementById('projectMembersCount').textContent =
                `–ü—Ä–æ–µ–∫—Ç: ${selectedProject.name}, –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${selectedProject.members.length}`;
            projectInfo.style.display = 'block';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            participantsList.innerHTML = '';
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            selectedProject.members.forEach(memberEmail => {
                let memberName = memberEmail;
                let initials = 'U';

                if (memberEmail === currentUser.email) {
                    memberName = `${currentUser.firstName} ${currentUser.lastName} (–í—ã)`;
                    initials = currentUser.firstName.charAt(0).toUpperCase() +
                              currentUser.lastName.charAt(0).toUpperCase();
                } else {
                    const user = users.find(u => u.email === memberEmail);
                    if (user) {
                        memberName = `${user.firstName} ${user.lastName}`;
                        initials = user.firstName.charAt(0).toUpperCase() +
                                  user.lastName.charAt(0).toUpperCase();
                    } else if (memberEmail.includes('@')) {
                        const nameFromEmail = memberEmail.split('@')[0];
                        memberName = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
                        initials = memberName.charAt(0).toUpperCase();
                    }
                }

                const isCurrentUser = memberEmail === currentUser.email;
                const participantItem = document.createElement('div');
                participantItem.className = `participant-item ${isCurrentUser ? 'current-user' : ''}`;
                participantItem.dataset.email = memberEmail;

                if (isCurrentUser) {
                    participantItem.classList.add('selected');
                    selectedParticipants.add(memberEmail);
                }

                participantItem.innerHTML = `
                    <div class="participant-avatar">${initials}</div>
                    <div class="participant-info">
                        <div class="participant-name">${memberName}</div>
                        <div class="participant-email">${memberEmail}</div>
                    </div>
                    <div class="participant-check">
                        <i class="fas fa-check"></i>
                    </div>
                `;

                if (!isCurrentUser) {
                    participantItem.onclick = function() {
                        this.classList.toggle('selected');

                        if (this.classList.contains('selected')) {
                            selectedParticipants.add(memberEmail);
                        } else {
                            selectedParticipants.delete(memberEmail);
                        }

                        updateCreateButton();
                    };
                }

                participantsList.appendChild(participantItem);
            });

            updateCreateButton();
        }

        function selectAllParticipants() {
            document.querySelectorAll('.participant-item').forEach(item => {
                item.classList.add('selected');
                selectedParticipants.add(item.dataset.email);
            });
            updateCreateButton();
        }

        function deselectAllParticipants() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            document.querySelectorAll('.participant-item').forEach(item => {
                if (item.dataset.email !== currentUser.email) {
                    item.classList.remove('selected');
                    selectedParticipants.delete(item.dataset.email);
                }
            });
            updateCreateButton();
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonth = document.getElementById('currentMonth');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ—Å—è—Ü–∞
            const monthNames = [
                '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
            ];

            currentMonth.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–Ω–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏)
            const dayElements = calendarGrid.querySelectorAll('.calendar-day');
            dayElements.forEach(day => day.remove());

            // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
            let firstDayIndex = firstDay.getDay();
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0)
            firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            for (let i = 0; i < firstDayIndex; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                calendarGrid.appendChild(dayElement);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let date = new Date(firstDay); date <= lastDay; date.setDate(date.getDate() + 1)) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                dayElement.dataset.date = date.toISOString().split('T')[0];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–µ–≥–æ–¥–Ω—è –ª–∏ —ç—Ç–æ
                const compareDate = new Date(date);
                compareDate.setHours(0, 0, 0, 0);

                if (compareDate.getTime() === today.getTime()) {
                    dayElement.classList.add('today');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å
                if (selectedDate && selectedDate.toDateString() === date.toDateString()) {
                    dayElement.classList.add('selected');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—Å—Ç—Ä–µ—á–∏ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
                if (hasMeetingsOnDate(date)) {
                    dayElement.classList.add('has-meetings');
                    dayElement.title = '–ï—Å—Ç—å –≤—Å—Ç—Ä–µ—á–∏';
                }

                dayElement.onclick = () => selectDate(new Date(date));
                calendarGrid.appendChild(dayElement);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –¥–æ –∫–æ–Ω—Ü–∞ —Å–µ—Ç–∫–∏
            const totalCells = 42; // 6 —Å—Ç—Ä–æ–∫ * 7 –¥–Ω–µ–π
            const daysAdded = firstDayIndex + lastDay.getDate();
            const nextMonthDays = totalCells - daysAdded;

            for (let i = 1; i <= nextMonthDays; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                calendarGrid.appendChild(dayElement);
            }
        }

        function selectDate(date) {
            selectedDate = new Date(date);
            selectedDate.setHours(0, 0, 0, 0);
            selectedTime = null;

            renderCalendar();
            loadTimeSlots();
            updateSelectedTimeInfo();
            updateCreateButton();
        }

        function hasMeetingsOnDate(date) {
            const meetings = JSON.parse(localStorage.getItem('meetings') || '[]');
            return meetings.some(meeting => {
                const meetingDate = new Date(meeting.date);
                return meetingDate.toDateString() === date.toDateString();
            });
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            loadTimeSlots();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            loadTimeSlots();
        }

        function loadTimeSlots() {
            const timeFrom = document.getElementById('timeFrom').value;
            const timeTo = document.getElementById('timeTo').value;
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');

            timeSlotsGrid.innerHTML = '';

            if (!selectedDate) {
                timeSlotsGrid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</p>';
                return;
            }

            // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è
            const [fromHour, fromMinute] = timeFrom.split(':').map(Number);
            const [toHour, toMinute] = timeTo.split(':').map(Number);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –ø–æ 30 –º–∏–Ω—É—Ç
            for (let hour = fromHour; hour <= toHour; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    if (hour === toHour && minute >= toMinute) break;

                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    const slotDate = new Date(selectedDate);
                    slotDate.setHours(hour, minute, 0, 0);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (–≤ –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏ –≤—Å–µ —Å–ª–æ—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã)
                    const isAvailable = true;

                    const slotElement = document.createElement('div');
                    slotElement.className = `time-slot ${isAvailable ? 'available' : 'unavailable'}`;
                    slotElement.dataset.time = timeString;

                    if (selectedTime && selectedTime.getTime() === slotDate.getTime()) {
                        slotElement.classList.add('selected');
                    }

                    slotElement.innerHTML = `
                        <div class="time-slot-label">${timeString}</div>
                        <div class="time-slot-status">${isAvailable ? '–°–≤–æ–±–æ–¥–Ω–æ' : '–ó–∞–Ω—è—Ç–æ'}</div>
                    `;

                    if (isAvailable) {
                        slotElement.onclick = () => selectTimeSlot(slotDate);
                    }

                    timeSlotsGrid.appendChild(slotElement);
                }
            }
        }

        function selectTimeSlot(dateTime) {
            selectedTime = dateTime;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö —Å–ª–æ—Ç–æ–≤
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–æ—Ç
            const timeString = dateTime.toTimeString().slice(0, 5);
            const selectedSlot = document.querySelector(`.time-slot[data-time="${timeString}"]`);
            if (selectedSlot) {
                selectedSlot.classList.add('selected');
            }

            updateSelectedTimeInfo();
            updateCreateButton();
        }

        function updateSelectedTimeInfo() {
            const selectedTimeInfo = document.getElementById('selectedTimeInfo');
            const selectedDateTime = document.getElementById('selectedDateTime');

            if (selectedDate && selectedTime) {
                const dateStr = selectedDate.toLocaleDateString('ru-RU', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                });
                const timeStr = selectedTime.toTimeString().slice(0, 5);

                selectedDateTime.textContent = `${dateStr}, ${timeStr}`;
                selectedTimeInfo.style.display = 'block';
            } else {
                selectedTimeInfo.style.display = 'none';
            }
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('createMeetingBtn');
            const isValid = selectedProject && selectedDate && selectedTime && selectedParticipants.size > 0;

            createBtn.disabled = !isValid;
            createBtn.title = isValid ? '–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        }

        function createMeeting() {
            if (!selectedProject || !selectedDate || !selectedTime || selectedParticipants.size === 0) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const meetingTitle = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –≤—Å—Ç—Ä–µ—á–∏:', `–°–æ–∑–≤–æ–Ω –ø–æ –ø—Ä–æ–µ–∫—Ç—É "${selectedProject.name}"`);
            if (!meetingTitle) return;

            const meetingDescription = prompt('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', '');

            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –≤—Å—Ç—Ä–µ—á–∏
            const meeting = {
                id: Date.now(),
                title: meetingTitle,
                description: meetingDescription || '',
                date: selectedTime.toISOString(),
                duration: 60, // 60 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                projectId: selectedProject.id,
                projectName: selectedProject.name,
                participants: Array.from(selectedParticipants),
                createdBy: JSON.parse(localStorage.getItem('currentUser')).email,
                createdAt: new Date().toISOString(),
                status: 'scheduled'
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—Ç—Ä–µ—á—É
            const meetings = JSON.parse(localStorage.getItem('meetings') || '[]');
            meetings.push(meeting);
            localStorage.setItem('meetings', JSON.stringify(meetings));

            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            createMeetingNotifications(meeting);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            const dateStr = selectedTime.toLocaleDateString('ru-RU');
            const timeStr = selectedTime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            alert(`‚úÖ –í—Å—Ç—Ä–µ—á–∞ —Å–æ–∑–¥–∞–Ω–∞!\n\nüìÖ ${dateStr} ${timeStr}\nüìã ${meetingTitle}\nüë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${selectedParticipants.size}\n\n–í—Å—Ç—Ä–µ—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å.`);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            resetSelection();
        }

        function createMeetingNotifications(meeting) {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const users = JSON.parse(localStorage.getItem('users') || []);

            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫—Ä–æ–º–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è
            meeting.participants.forEach(participantEmail => {
                if (participantEmail !== currentUser.email) {
                    const participant = users.find(u => u.email === participantEmail);
                    const participantName = participant ? `${participant.firstName} ${participant.lastName}` : participantEmail;

                    notifications.unshift({
                        id: Date.now() + Math.random(),
                        type: 'system',
                        title: '–ù–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞',
                        message: `${currentUser.firstName} –ø—Ä–∏–≥–ª–∞—Å–∏–ª(–∞) –≤–∞—Å –Ω–∞ –≤—Å—Ç—Ä–µ—á—É "${meeting.title}"`,
                        project: meeting.projectName,
                        time: new Date().toISOString(),
                        read: false,
                        action: 'meetings.html'
                    });
                }
            });

            localStorage.setItem('notifications', JSON.stringify(notifications));
        }

        function resetSelection() {
            selectedDate = null;
            selectedTime = null;
            selectedParticipants.clear();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
            renderCalendar();
            loadTimeSlots();
            updateSelectedTimeInfo();
            updateCreateButton();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            document.querySelectorAll('.participant-item').forEach(item => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (item.dataset.email === currentUser.email) {
                    item.classList.add('selected');
                    selectedParticipants.add(currentUser.email);
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function showMeetingHistory() {
            const meetings = JSON.parse(localStorage.getItem('meetings') || '[]');
            const userMeetings = meetings.filter(meeting =>
                meeting.participants.includes(JSON.parse(localStorage.getItem('currentUser')).email)
            );

            if (userMeetings.length === 0) {
                alert('–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á');
                return;
            }

            let history = 'üìÖ –í–∞—à–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏:\n\n';

            userMeetings.sort((a, b) => new Date(a.date) - new Date(b.date));

            userMeetings.forEach((meeting, index) => {
                const date = new Date(meeting.date);
                const dateStr = date.toLocaleDateString('ru-RU');
                const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                history += `${index + 1}. ${meeting.title}\n`;
                history += `   üìç ${meeting.projectName}\n`;
                history += `   üìÖ ${dateStr} ${timeStr}\n`;
                history += `   üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${meeting.participants.length}\n\n`;
            });

            alert(history);
        }
    </script>

    <style>
        .meetings-page {
            padding-bottom: 100px;
        }

        .project-selection {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .project-selection h3 {
            margin: 0 0 16px 0;
            color: var(--text-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-project-info {
            margin-top: 12px;
            padding: 12px;
            background: var(--primary-light);
            border-radius: 8px;
            color: var(--primary-color);
            font-size: 14px;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å - —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π */
        .calendar-section {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .month-navigation {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .current-month {
            font-size: 14px;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
            color: var(--text-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã */
        }

        .calendar-day-header {
            text-align: center;
            font-size: 11px; /* –£–º–µ–Ω—å—à–∏–ª–∏ —à—Ä–∏—Ñ—Ç */
            color: var(--text-secondary);
            padding: 8px 0;
            font-weight: 600;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: 500;
            font-size: 13px; /* –£–º–µ–Ω—å—à–∏–ª–∏ —à—Ä–∏—Ñ—Ç */
            color: var(--text-color);
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: var(--hover-bg);
            border-color: var(--border-color);
        }

        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .calendar-day.today {
            border: 2px solid var(--primary-color);
        }

        .calendar-day.other-month {
            color: var(--text-disabled);
            opacity: 0.5;
            cursor: default;
        }

        .calendar-day.other-month:hover {
            background: transparent;
            border-color: transparent;
        }

        .calendar-day.has-meetings::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--primary-color);
        }

        /* –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ */
        .time-selection {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .time-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .time-selection-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-input {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--surface-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .time-slot {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .time-slot:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .time-slot.available {
            cursor: pointer;
        }

        .time-slot.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--disabled-bg);
        }

        .time-slot-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .time-slot-status {
            font-size: 10px;
            opacity: 0.8;
        }

        .time-slot.selected .time-slot-status {
            color: rgba(255, 255, 255, 0.8);
        }

        .selected-time-info {
            margin-top: 16px;
            padding: 12px;
            background: var(--success-light);
            border-radius: 8px;
            color: var(--success-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* –£—á–∞—Å—Ç–Ω–∏–∫–∏ */
        .participants-section {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 80px;
            border: 1px solid var(--border-color);
        }

        .participants-section h3 {
            margin: 0 0 16px 0;
            color: var(--text-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .participants-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .participant-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            gap: 12px;
        }

        .participant-item:hover {
            border-color: var(--border-color);
        }

        .participant-item.selected {
            background: var(--primary-light);
            border-color: var(--primary-color);
        }

        .participant-item.current-user {
            background: var(--success-light);
            cursor: default;
        }

        .participant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .participant-item.selected .participant-avatar {
            background: var(--primary-color);
            color: white;
        }

        .participant-item.current-user .participant-avatar {
            background: var(--success-color);
            color: white;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 500;
            margin-bottom: 2px;
            color: var(--text-color);
        }

        .participant-email {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .participant-check {
            color: var(--primary-color);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .participant-item.selected .participant-check {
            opacity: 1;
        }

        .participants-actions {
            display: flex;
            gap: 8px;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ */
        .meeting-actions-bottom {
            position: fixed;
            bottom: 80px; /* –ü–æ–¥–Ω—è–ª–∏ –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ—Å—å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π */
            left: 20px;
            right: 20px;
            z-index: 100;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .calendar-grid {
                gap: 4px;
            }

            .calendar-day {
                font-size: 12px;
            }

            .time-slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .time-selection-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .time-range {
                width: 100%;
            }

            .participants-actions {
                flex-direction: column;
            }

            .meeting-actions-bottom {
                bottom: 70px;
                left: 10px;
                right: 10px;
            }
        }

        .success-light {
            background: #D1FAE5;
        }

        .disabled-bg {
            background: var(--border-color);
        }
    </style>
</body>
</html>
