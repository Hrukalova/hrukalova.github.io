<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <script>
        if (!localStorage.getItem('currentUser')) {
            window.location.href = 'index.html';
        }

        const projectId = parseInt(new URLSearchParams(window.location.search).get('projectId'));

        if (!projectId) {
            window.location.href = 'dashboard.html';
        }

        const settings = JSON.parse(localStorage.getItem('settings') || '{}');
        if (settings.darkTheme) {
            document.body.classList.add('dark-theme');
        }
    </script>

    <header class="header">
        <a href="project-details.html?id=${projectId}" class="icon-btn">
            <i class="fas fa-arrow-left"></i>
        </a>

        <div class="header-title">
            <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã</h1>
        </div>

        <div class="header-actions">
            <button class="icon-btn" onclick="shareStats()" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                <i class="fas fa-share-alt"></i>
            </button>
        </div>
    </header>

    <main class="container stats-page">
        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #4a6cf7;">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background-color: #51cf66;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="completedTasks">0</div>
                    <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background-color: #ff6b6b;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="overdueTasks">0</div>
                    <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background-color: #ff922b;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="activeMembers">0</div>
                    <div class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º -->
        <div class="section">
            <h2>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º</h2>
            <div class="section-progress" id="sectionProgress">
                <!-- –ó–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
        <div class="section">
            <h2>–í–∫–ª–∞–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
            <div class="members-contribution" id="membersContribution">
                <!-- –ó–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–¥–∞—á–∞–º -->
        <div class="section">
            <h2>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="detailed-stats" id="detailedStats">
                <!-- –ó–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" -->
    <div class="modal" id="shareModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π</h3>
                <button class="icon-btn" onclick="closeShareModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <h4>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç:</h4>
                <div class="chats-list" id="chatsList">
                    <div class="chat-item" onclick="shareToChat('–û–±—â–∏–π —á–∞—Ç –∫–æ–º–∞–Ω–¥—ã')">
                        <div class="chat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="chat-info">
                            <h5>–û–±—â–∏–π —á–∞—Ç –∫–æ–º–∞–Ω–¥—ã</h5>
                            <p>–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</p>
                        </div>
                    </div>

                    <div class="chat-item" onclick="shareToChat('–ß–∞—Ç —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º')">
                        <div class="chat-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="chat-info">
                            <h5>–ß–∞—Ç —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º</h5>
                            <p>–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
                        </div>
                    </div>

                    <div class="chat-item" onclick="shareToChat('–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —á–∞—Ç')">
                        <div class="chat-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <div class="chat-info">
                            <h5>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —á–∞—Ç</h5>
                            <p>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã</p>
                        </div>
                    </div>
                </div>

                <div class="share-summary">
                    <h4>–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</h4>
                    <p id="shareSummary">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeShareModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        projectId = parseInt(new URLSearchParams(window.location.search).get('projectId'));

        document.addEventListener('DOMContentLoaded', function() {
            loadProjectStats();
        });

        function loadProjectStats() {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            currentProject = projects.find(p => p.id === projectId);

            if (!currentProject) {
                alert('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                window.history.back();
                return;
            }

            updateOverviewStats();
            updateSectionProgress();
            updateMembersContribution();
            updateDetailedStats();
        }

        function updateOverviewStats() {
            if (!currentProject.tasks) {
                document.getElementById('totalTasks').textContent = '0';
                document.getElementById('completedTasks').textContent = '0';
                document.getElementById('overdueTasks').textContent = '0';
                document.getElementById('activeMembers').textContent = currentProject.members?.length || '0';
                return;
            }

            const totalTasks = currentProject.tasks.length;
            const completedTasks = currentProject.tasks.filter(task => task.completed).length;

            const now = new Date();
            const overdueTasks = currentProject.tasks.filter(task => {
                if (task.completed || !task.deadline) return false;
                const deadline = new Date(task.deadline);
                return deadline < now;
            }).length;

            // –ê–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ - —Ç–µ, –∫–æ–º—É –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∑–∞–¥–∞—á–∏
            const assignedMembers = new Set();
            currentProject.tasks.forEach(task => {
                if (task.assignees) {
                    task.assignees.forEach(member => assignedMembers.add(member));
                }
            });

            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('overdueTasks').textContent = overdueTasks;
            document.getElementById('activeMembers').textContent = assignedMembers.size;
        }

        function updateSectionProgress() {
            const sectionProgress = document.getElementById('sectionProgress');
            sectionProgress.innerHTML = '';

            if (!currentProject.sections || currentProject.sections.length === 0) {
                sectionProgress.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder"></i>
                        <p>–ù–µ—Ç —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ</p>
                    </div>
                `;
                return;
            }

            currentProject.sections.forEach(section => {
                const sectionTasks = currentProject.tasks?.filter(task => task.section === section) || [];
                const total = sectionTasks.length;
                const completed = sectionTasks.filter(task => task.completed).length;
                const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-progress-item';
                sectionDiv.innerHTML = `
                    <div class="section-header">
                        <h4>${section}</h4>
                        <span>${completed}/${total} –∑–∞–¥–∞—á</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${progress}%"></div>
                    </div>
                    <div class="progress-text">${progress}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                `;
                sectionProgress.appendChild(sectionDiv);
            });
        }

        function updateMembersContribution() {
            const membersContribution = document.getElementById('membersContribution');
            membersContribution.innerHTML = '';

            if (!currentProject.members || currentProject.members.length === 0) {
                membersContribution.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ</p>
                    </div>
                `;
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
            const memberStats = {};

            currentProject.members.forEach(member => {
                memberStats[member] = {
                    totalTasks: 0,
                    completedTasks: 0,
                    createdTasks: 0,
                    updates: 0
                };
            });

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏
            if (currentProject.tasks) {
                currentProject.tasks.forEach(task => {
                    // –°–æ–∑–¥–∞—Ç–µ–ª—å –∑–∞–¥–∞—á–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–µ—Ä–≤—ã–π –≤ assignees –∏–ª–∏ –∞–≤—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞)
                    if (task.assignees && task.assignees.length > 0) {
                        const creator = task.assignees[0];
                        if (memberStats[creator]) {
                            memberStats[creator].createdTasks++;
                        }
                    }

                    // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞ –∑–∞–¥–∞—á–∏
                    if (task.assignees) {
                        task.assignees.forEach(assignee => {
                            if (memberStats[assignee]) {
                                memberStats[assignee].totalTasks++;
                                if (task.completed) {
                                    memberStats[assignee].completedTasks++;
                                }
                            }
                        });
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∞–ø–¥–µ–π—Ç—ã)
                    if (task.updates) {
                        task.updates.forEach(update => {
                            // –ù–∞—Ö–æ–¥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∞
                            Object.keys(memberStats).forEach(member => {
                                if (member.includes(update.author.split(' ')[0]) ||
                                    update.author.includes(member.split(' ')[0])) {
                                    memberStats[member].updates++;
                                }
                            });
                        });
                    }
                });
            }

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
            const sortedMembers = Object.entries(memberStats)
                .map(([member, stats]) => ({ member, ...stats }))
                .sort((a, b) => b.completedTasks - a.completedTasks);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ø-5 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            sortedMembers.slice(0, 5).forEach((stats, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-stat-item';

                let displayName = stats.member;
                let initials = '';

                if (stats.member.includes('@')) {
                    const username = stats.member.split('@')[0];
                    displayName = username.charAt(0).toUpperCase() + username.slice(1);
                    initials = username.charAt(0).toUpperCase();
                } else {
                    const nameParts = stats.member.split(' ');
                    initials = nameParts.map(part => part.charAt(0)).join('').toUpperCase();
                }

                const completionRate = stats.totalTasks > 0 ?
                    Math.round((stats.completedTasks / stats.totalTasks) * 100) : 0;

                // –ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';

                memberDiv.innerHTML = `
                    <div class="member-rank ${rankClass}">${index + 1}</div>
                    <div class="member-avatar">${initials}</div>
                    <div class="member-info">
                        <h5>${displayName}</h5>
                        <div class="member-stats">
                            <span>${stats.completedTasks}/${stats.totalTasks} –∑–∞–¥–∞—á</span>
                            <span>${stats.updates} –∞–ø–¥–µ–π—Ç–æ–≤</span>
                        </div>
                    </div>
                    <div class="member-progress">
                        <div class="progress-bar small">
                            <div class="progress" style="width: ${completionRate}%"></div>
                        </div>
                        <span>${completionRate}%</span>
                    </div>
                `;
                membersContribution.appendChild(memberDiv);
            });

            if (sortedMembers.length === 0) {
                membersContribution.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
                    </div>
                `;
            }
        }

        function updateDetailedStats() {
            const detailedStats = document.getElementById('detailedStats');
            detailedStats.innerHTML = '';

            if (!currentProject.tasks || currentProject.tasks.length === 0) {
                detailedStats.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-list-alt"></i>
                        <p>–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
                    </div>
                `;
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É
            const statusStats = {
                completed: currentProject.tasks.filter(t => t.completed).length,
                overdue: currentProject.tasks.filter(t => {
                    if (t.completed || !t.deadline) return false;
                    return new Date(t.deadline) < new Date();
                }).length,
                upcoming: currentProject.tasks.filter(t => {
                    if (t.completed || !t.deadline) return false;
                    const deadline = new Date(t.deadline);
                    const now = new Date();
                    const daysDiff = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                    return daysDiff <= 7 && daysDiff >= 0;
                }).length,
                noDeadline: currentProject.tasks.filter(t => !t.deadline && !t.completed).length
            };

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
            const priorityStats = {
                high: currentProject.tasks.filter(t => t.priority === 'high').length,
                medium: currentProject.tasks.filter(t => !t.priority || t.priority === 'medium').length,
                low: currentProject.tasks.filter(t => t.priority === 'low').length
            };

            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const statsHtml = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <h4>–ü–æ —Å—Ç–∞—Ç—É—Å—É</h4>
                        <ul class="stat-list">
                            <li>
                                <i class="fas fa-check-circle" style="color: #51cf66;"></i>
                                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</span>
                                <strong>${statusStats.completed}</strong>
                            </li>
                            <li>
                                <i class="fas fa-exclamation-circle" style="color: #ff6b6b;"></i>
                                <span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ:</span>
                                <strong>${statusStats.overdue}</strong>
                            </li>
                            <li>
                                <i class="fas fa-clock" style="color: #ff922b;"></i>
                                <span>–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ:</span>
                                <strong>${statusStats.upcoming}</strong>
                            </li>
                            <li>
                                <i class="fas fa-question-circle" style="color: #868e96;"></i>
                                <span>–ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞:</span>
                                <strong>${statusStats.noDeadline}</strong>
                            </li>
                        </ul>
                    </div>

                    <div class="stat-box">
                        <h4>–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</h4>
                        <ul class="stat-list">
                            <li>
                                <i class="fas fa-arrow-up" style="color: #ff6b6b;"></i>
                                <span>–í—ã—Å–æ–∫–∏–π:</span>
                                <strong>${priorityStats.high}</strong>
                            </li>
                            <li>
                                <i class="fas fa-minus" style="color: #ff922b;"></i>
                                <span>–°—Ä–µ–¥–Ω–∏–π:</span>
                                <strong>${priorityStats.medium}</strong>
                            </li>
                            <li>
                                <i class="fas fa-arrow-down" style="color: #51cf66;"></i>
                                <span>–ù–∏–∑–∫–∏–π:</span>
                                <strong>${priorityStats.low}</strong>
                            </li>
                        </ul>
                    </div>

                    <div class="stat-box">
                        <h4>–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
                        <ul class="stat-list">
                            <li>
                                <i class="fas fa-calendar-alt"></i>
                                <span>–°–æ–∑–¥–∞–Ω:</span>
                                <strong>${currentProject.createdAt ?
                                    new Date(currentProject.createdAt).toLocaleDateString('ru-RU') :
                                    '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong>
                            </li>
                            <li>
                                <i class="fas fa-percentage"></i>
                                <span>–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:</span>
                                <strong>${calculateProjectProgress()}%</strong>
                            </li>
                            <li>
                                <i class="fas fa-chart-line"></i>
                                <span>–¢–µ–º–ø –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
                                <strong>${calculateCompletionRate()} –∑–∞–¥–∞—á/–Ω–µ–¥–µ–ª—è</strong>
                            </li>
                        </ul>
                    </div>
                </div>
            `;

            detailedStats.innerHTML = statsHtml;
        }

        function calculateProjectProgress() {
            if (!currentProject.tasks || currentProject.tasks.length === 0) return 0;
            const completed = currentProject.tasks.filter(task => task.completed).length;
            return Math.round((completed / currentProject.tasks.length) * 100);
        }

        function calculateCompletionRate() {
            if (!currentProject.createdAt || !currentProject.tasks) return '0';

            const createdDate = new Date(currentProject.createdAt);
            const now = new Date();
            const weeksDiff = Math.max(1, Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24 * 7)));

            const completedTasks = currentProject.tasks.filter(task => task.completed).length;
            return (completedTasks / weeksDiff).toFixed(1);
        }

        function shareStats() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const totalTasks = currentProject.tasks?.length || 0;
            const completedTasks = currentProject.tasks?.filter(t => t.completed).length || 0;
            const progress = calculateProjectProgress();

            document.getElementById('shareSummary').innerHTML = `
                <strong>${currentProject.name}</strong><br>
                –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}% (${completedTasks}/${totalTasks} –∑–∞–¥–∞—á)<br>
                –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${currentProject.members?.length || 0}<br>
                –î–µ–¥–ª–∞–π–Ω: ${currentProject.deadline ?
                    new Date(currentProject.deadline).toLocaleDateString('ru-RU') :
                    '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
            `;

            document.getElementById('shareModal').style.display = 'block';
        }

        function shareToChat(chatName) {
            const totalTasks = currentProject.tasks?.length || 0;
            const completedTasks = currentProject.tasks?.filter(t => t.completed).length || 0;
            const progress = calculateProjectProgress();

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
            const message = `
üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: ${currentProject.name}*

‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${completedTasks}/${totalTasks} –∑–∞–¥–∞—á
üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%
üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${currentProject.members?.length || 0}
‚è∞ –î–µ–¥–ª–∞–π–Ω: ${currentProject.deadline ?
    new Date(currentProject.deadline).toLocaleDateString('ru-RU') :
    '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}

*–¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–∏:*
${getTopMembers(3)}

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–∑ Research App
            `;

            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã API –≤—ã–∑–æ–≤
            alert(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —á–∞—Ç: "${chatName}"\n\n${message}`);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeShareModal();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            showNotification('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ ' + chatName);
        }

        function getTopMembers(limit) {
            if (!currentProject.tasks || !currentProject.members) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

            const memberStats = {};
            currentProject.members.forEach(member => {
                memberStats[member] = {
                    completed: 0,
                    total: 0
                };
            });

            currentProject.tasks.forEach(task => {
                if (task.assignees) {
                    task.assignees.forEach(assignee => {
                        if (memberStats[assignee]) {
                            memberStats[assignee].total++;
                            if (task.completed) {
                                memberStats[assignee].completed++;
                            }
                        }
                    });
                }
            });

            const sorted = Object.entries(memberStats)
                .map(([member, stats]) => ({ member, ...stats }))
                .sort((a, b) => b.completed - a.completed)
                .slice(0, limit);

            return sorted.map((stats, index) => {
                const name = stats.member.includes('@') ?
                    stats.member.split('@')[0] :
                    stats.member.split(' ')[0];
                return `${index + 1}. ${name}: ${stats.completed}/${stats.total} –∑–∞–¥–∞—á`;
            }).join('\n');
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        function showNotification(message) {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>

    <style>
        .notification {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item ${window.location.pathname.includes('dashboard') ? 'active' : ''}">
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
        </a>

        <a href="notifications.html" class="nav-item ${window.location.pathname.includes('notifications') ? 'active' : ''}">
            <i class="fas fa-bell nav-icon"></i>
            <span class="nav-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            <span class="notification-badge" id="notificationCount"></span>
        </a>

        <a href="meetings.html" class="nav-item ${window.location.pathname.includes('meetings') ? 'active' : ''}">
            <i class="fas fa-phone-alt nav-icon"></i>
            <span class="nav-label">–°–æ–∑–≤–æ–Ω—ã</span>
        </a>

        <a href="project-chats.html" class="nav-item ${window.location.pathname.includes('chat') ? 'active' : ''}">
            <i class="fas fa-comments nav-icon"></i>
            <span class="nav-label">–ß–∞—Ç—ã</span>
        </a>
    </nav>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function updateNotificationBadge() {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationCount');

            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateNotificationBadge();
        });
    </script>
</body>
</html>
