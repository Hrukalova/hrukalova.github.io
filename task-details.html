<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали задачи</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <script>
        if (!localStorage.getItem('currentUser')) {
            window.location.href = 'index.html';
        }
    </script>

    <header class="header">
        <a href="project-details.html" class="icon-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">
            <h1 id="taskTitle">Задача</h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="toggleTaskStatus()" id="statusBtn" title="Изменить статус">
                <i class="far fa-circle"></i>
            </button>
        </div>
    </header>

    <!-- Вкладки -->
    <div class="tabs task-tabs">
        <button class="tab active" onclick="showTab('details')">Детали</button>
        <button class="tab" onclick="showTab('updates')">Обновления</button>
        <button class="tab" onclick="showTab('files')">Файлы</button>
    </div>

    <main class="container task-details-page">
        <!-- Вкладка Детали -->
        <div id="detailsTab" class="tab-content active">
            <div class="task-info">
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-layer-group"></i> Раздел:</span>
                    <span class="info-value" id="taskSection"></span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-user"></i> Исполнитель:</span>
                    <span class="info-value" id="taskAssignee"></span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="far fa-calendar"></i> Дедлайн:</span>
                    <span class="info-value" id="taskDeadline"></span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-flag"></i> Приоритет:</span>
                    <span class="info-value" id="taskPriority"></span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-clock"></i> Статус:</span>
                    <span class="info-value" id="taskStatus"></span>
                </div>
            </div>

            <div class="task-description-box">
                <h3><i class="fas fa-align-left"></i> Описание</h3>
                <div id="taskDescription"></div>
            </div>

            <div class="task-actions">
                <button class="btn btn-secondary" onclick="editTask()">
                    <i class="fas fa-edit"></i> Редактировать
                </button>
                <button class="btn btn-primary" onclick="markAsDone()">
                    <i class="fas fa-check"></i> Отметить выполненной
                </button>
            </div>
        </div>

        <!-- Вкладка Обновления -->
        <div id="updatesTab" class="tab-content">
            <div class="updates-list" id="updatesList">
                <!-- Обновления загрузятся через JS -->
            </div>

            <div class="add-update">
                <h3><i class="fas fa-plus-circle"></i> Добавить обновление</h3>
                <textarea id="updateText" class="form-input"
                          placeholder="Опишите прогресс по задаче..."
                          rows="3"></textarea>
                <button class="btn btn-primary" onclick="addUpdate()">
                    <i class="fas fa-paper-plane"></i> Добавить
                </button>
            </div>
        </div>

        <!-- Вкладка Файлы -->
        <div id="filesTab" class="tab-content">
            <div class="files-list" id="filesList">
                <!-- Файлы загрузятся через JS -->
            </div>

            <div class="file-upload">
                <h3><i class="fas fa-cloud-upload-alt"></i> Загрузить файл</h3>
                <input type="file" id="fileInput" class="form-input" multiple>
                <button class="btn btn-primary" onclick="uploadFile()">
                    <i class="fas fa-upload"></i> Загрузить
                </button>
            </div>
        </div>
    </main>

    <script>
        let currentTask = null;
        let projectId = null;
        let taskId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            projectId = parseInt(urlParams.get('projectId'));
            taskId = parseInt(urlParams.get('taskId'));

            if (!projectId || !taskId) {
                window.location.href = 'dashboard.html';
                return;
            }

            loadTaskDetails();
        });

        function loadTaskDetails() {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const project = projects.find(p => p.id === projectId);

            if (!project) {
                alert('Проект не найден');
                window.location.href = 'dashboard.html';
                return;
            }

            const task = (project.tasks || []).find(t => t.id === taskId);
            if (!task) {
                alert('Задача не найдена');
                window.location.href = `project-details.html?id=${projectId}`;
                return;
            }

            currentTask = task;

            // Заполняем информацию о задаче
            document.getElementById('taskTitle').textContent = task.title;
            document.getElementById('taskSection').textContent = task.section || 'Не указан';

            // Исполнители
            let assigneeText = 'Не назначен';
            if (task.assignees && task.assignees.length > 0) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const assigneeNames = task.assignees.map(email => {
                    const user = users.find(u => u.email === email);
                    return user ? `${user.firstName} ${user.lastName}` : email.split('@')[0];
                });
                assigneeText = assigneeNames.join(', ');
            }
            document.getElementById('taskAssignee').textContent = assigneeText;

            // Дедлайн
            const deadline = new Date(task.deadline);
            const now = new Date();
            const daysDiff = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));

            let deadlineText = deadline.toLocaleDateString('ru-RU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            if (daysDiff < 0) {
                deadlineText += ` (Просрочено на ${Math.abs(daysDiff)} дн.)`;
            } else if (daysDiff === 0) {
                deadlineText += ' (Сегодня)';
            } else if (daysDiff === 1) {
                deadlineText += ' (Завтра)';
            } else {
                deadlineText += ` (Через ${daysDiff} дн.)`;
            }

            document.getElementById('taskDeadline').textContent = deadlineText;
            document.getElementById('taskDeadline').style.color =
                task.completed ? 'var(--success-color)' :
                daysDiff < 0 ? 'var(--danger-color)' :
                daysDiff <= 3 ? 'var(--warning-color)' : 'var(--text-color)';

            // Приоритет
            document.getElementById('taskPriority').textContent =
                task.priority === 'high' ? 'Высокий' :
                task.priority === 'low' ? 'Низкий' : 'Средний';
            document.getElementById('taskPriority').style.color =
                task.priority === 'high' ? 'var(--danger-color)' :
                task.priority === 'low' ? 'var(--success-color)' : 'var(--warning-color)';

            // Статус
            const statusText = task.completed ? 'Выполнено' : 'В работе';
            const statusColor = task.completed ? 'var(--success-color)' : 'var(--primary-color)';
            document.getElementById('taskStatus').textContent = statusText;
            document.getElementById('taskStatus').style.color = statusColor;

            // Описание
            document.getElementById('taskDescription').textContent =
                task.description || 'Описание отсутствует';

            // Кнопка статуса
            const statusBtn = document.getElementById('statusBtn');
            statusBtn.innerHTML = task.completed ?
                '<i class="fas fa-check-circle"></i>' :
                '<i class="far fa-circle"></i>';
            statusBtn.style.color = statusColor;

            // Загружаем обновления и файлы
            loadUpdates();
            loadFiles();
        }

        function showTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Показываем нужную вкладку
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Активируем кнопку
            event.target.classList.add('active');
        }

        function toggleTaskStatus() {
            if (!currentTask) return;

            currentTask.completed = !currentTask.completed;

            // Сохраняем изменения
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const projectIndex = projects.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                const taskIndex = projects[projectIndex].tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    projects[projectIndex].tasks[taskIndex] = currentTask;
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
            }

            // Обновляем UI
            loadTaskDetails();

            // Добавляем обновление
            const updateText = currentTask.completed ?
                'Задача отмечена как выполненная' :
                'Задача возобновлена';
            addUpdateToTask(updateText);
        }

        function markAsDone() {
            if (!currentTask.completed) {
                toggleTaskStatus();
            }
        }

        function editTask() {
            window.location.href = `edit-task.html?projectId=${projectId}&taskId=${taskId}`;
        }

        function addUpdate() {
            const text = document.getElementById('updateText').value.trim();
            if (!text) {
                alert('Введите текст обновления');
                return;
            }

            addUpdateToTask(text);
            document.getElementById('updateText').value = '';

            // Переключаемся на вкладку обновлений
            showTab('updates');
        }

        function addUpdateToTask(text) {
            if (!currentTask.updates) {
                currentTask.updates = [];
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            currentTask.updates.unshift({
                id: Date.now(),
                text: text,
                author: `${currentUser.firstName} ${currentUser.lastName}`,
                authorEmail: currentUser.email,
                time: new Date().toISOString()
            });

            // Сохраняем изменения
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const projectIndex = projects.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                const taskIndex = projects[projectIndex].tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    projects[projectIndex].tasks[taskIndex] = currentTask;
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
            }

            loadUpdates();
        }

        function loadUpdates() {
            const updatesList = document.getElementById('updatesList');
            updatesList.innerHTML = '';

            if (!currentTask.updates || currentTask.updates.length === 0) {
                updatesList.innerHTML = `
                    <div class="empty-updates">
                        <i class="fas fa-comment-slash"></i>
                        <p>Пока нет обновлений</p>
                    </div>
                `;
                return;
            }

            currentTask.updates.forEach(update => {
                const time = new Date(update.time);
                const timeStr = time.toLocaleString('ru-RU', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const updateItem = document.createElement('div');
                updateItem.className = 'update-item';
                updateItem.innerHTML = `
                    <div class="update-header">
                        <div class="update-author">
                            <i class="fas fa-user"></i> ${update.author}
                        </div>
                        <div class="update-time">${timeStr}</div>
                    </div>
                    <div class="update-text">${update.text}</div>
                `;
                updatesList.appendChild(updateItem);
            });
        }

        function loadFiles() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';

            if (!currentTask.files || currentTask.files.length === 0) {
                filesList.innerHTML = `
                    <div class="empty-files">
                        <i class="fas fa-file-upload"></i>
                        <p>Пока нет файлов</p>
                    </div>
                `;
                return;
            }

            currentTask.files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${file.size}</div>
                    </div>
                    <button class="icon-btn btn-small" onclick="downloadFile('${file.name}')">
                        <i class="fas fa-download"></i>
                    </button>
                `;
                filesList.appendChild(fileItem);
            });
        }

        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert('Выберите файл для загрузки');
                return;
            }

            const file = fileInput.files[0];

            if (!currentTask.files) {
                currentTask.files = [];
            }

            // В реальном приложении здесь был бы upload на сервер
            // Сейчас сохраняем только информацию о файле
            currentTask.files.push({
                id: Date.now(),
                name: file.name,
                size: formatFileSize(file.size),
                type: file.type,
                uploadTime: new Date().toISOString()
            });

            // Сохраняем изменения
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const projectIndex = projects.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                const taskIndex = projects[projectIndex].tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    projects[projectIndex].tasks[taskIndex] = currentTask;
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
            }

            fileInput.value = '';
            loadFiles();

            // Добавляем обновление о загрузке файла
            addUpdateToTask(`Загружен файл: ${file.name}`);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(filename) {
            alert(`В реальном приложении файл "${filename}" начал бы скачиваться`);
        }
    </script>

    <style>
        .task-details-page {
            padding-bottom: 20px;
        }

        .task-tabs {
            margin: 0;
            padding: 0 20px;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
        }

        .tab-content {
            display: none;
            padding: 24px;
        }

        .tab-content.active {
            display: block;
        }

        .task-info {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-label {
            width: 120px;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-value {
            flex: 1;
            color: var(--text-color);
            font-weight: 500;
        }

        .task-description-box {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .task-description-box h3 {
            margin: 0 0 16px 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #taskDescription {
            line-height: 1.6;
            color: var(--text-color);
        }

        .task-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .updates-list {
            margin-bottom: 32px;
        }

        .update-item {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .update-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .update-author {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-time {
            color: var(--text-secondary);
        }

        .update-text {
            line-height: 1.5;
            color: var(--text-color);
        }

        .empty-updates, .empty-files {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-updates i, .empty-files i {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .files-list {
            margin-bottom: 32px;
        }

        .file-item {
            display: flex;
            align-items: center;
            background: var(--surface-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            gap: 16px;
        }

        .file-icon {
            font-size: 24px;
            color: var(--primary-color);
            width: 40px;
            text-align: center;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-color);
        }

        .file-size {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .add-update, .file-upload {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .add-update h3, .file-upload h3 {
            margin: 0 0 16px 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #updateText {
            margin-bottom: 16px;
        }

        #fileInput {
            margin-bottom: 16px;
            padding: 12px;
        }
    </style>
</body>
</html>
